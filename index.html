<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Better Product</title>
  <meta name="description" content="The Better Product — design-forward consumer goods built with intention." />

  <!-- Mobile browser UI tint (updated dynamically in JS too) -->
  <meta name="theme-color" content="#D6E9F8" id="themeColorMeta">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --radius: 22px;
      --pageBg: #fff;
      --pageText: #111;

      --cardBg:#fff;
      --cardStroke: rgba(17,17,17,.08);
      --shadow:0 12px 28px rgba(0,0,0,.10);
      --shadowHover:0 18px 42px rgba(0,0,0,.14);
      --tileRadius:28px;

      --easeApple:cubic-bezier(.22,.61,.36,1);
      --easeOut:cubic-bezier(.2,.8,.2,1);

      --contentMax:1180px;
      --gutter:clamp(16px,4vw,56px);

      /* ==============================
         ✅ Rail sizing (Red Bull-ish cards)
         ============================== */
      --railGap: clamp(14px, 2vw, 22px);
      --railTileMinHeight: clamp(440px, 56vh, 560px);
      --railMediaRatio: 4 / 5;

      /* Container alignment helpers */
      --containerPad: max(var(--gutter), calc((100vw - var(--contentMax))/2 + var(--gutter)));

      /* Brand tints */
      --uiTint: #D6E9F8;
      --uiTintLab: #0B0B0B;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--pageBg);
      color:var(--pageText);
    }
    a{ color:inherit; text-decoration:none; }

    /* ==============================
       LAB THEME (activated by html.lab)
       ============================== */
    html.lab{
      --pageBg:#0b0b0b;
      --pageText:#f4f4f4;
      --cardBg:#121212;
      --cardStroke: rgba(255,255,255,.10);
      --shadow:0 14px 34px rgba(0,0,0,.45);
      --shadowHover:0 18px 46px rgba(0,0,0,.55);
    }
    html.lab .tileMedia{ background:#0f0f0f; }
    html.lab .tileBody{ border-top-color: rgba(255,255,255,.12); }
    html.lab .railArrow svg{ stroke:#f4f4f4; }
    html.lab .railArrow{ background:rgba(255,255,255,.10); }
    html.lab .railArrow:hover{ background:rgba(255,255,255,.14); }
    html.lab .sectionTitle{ color:#fff; }

    /* ==============================
       LOGO LOADER (refresh/tap)
       ============================== */
    .loader{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      background:rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      opacity:0;
      pointer-events:none;
      transition:opacity .25s var(--easeOut);
      z-index:9999;
    }
    html.lab .loader{ background:rgba(10,10,10,.78); }
    .loader.isOn{ opacity:1; pointer-events:auto; }
    .loader img{
      width:72px;
      height:auto;
      opacity:0;
      transform:scale(.96);
      animation: logoPulse .8s var(--easeApple) forwards;
      filter: drop-shadow(0 14px 30px rgba(0,0,0,.20));
    }
    @keyframes logoPulse{
      0%{ opacity:0; transform:scale(.96); }
      40%{ opacity:1; transform:scale(1); }
      100%{ opacity:0; transform:scale(1.04); }
    }

    /* ==============================
       SMOKE TRANSITION OVERLAY
       ============================== */
    .smoke{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:0;
      z-index:9996;
      transition: opacity .25s var(--easeOut);
    }
    .smoke.isOn{ opacity:1; }
    .smoke .puff{
      position:absolute;
      inset:-30vh -30vw;
      background:
        radial-gradient(circle at 20% 35%, rgba(255,255,255,.26), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 62% 42%, rgba(255,255,255,.18), rgba(255,255,255,0) 58%),
        radial-gradient(circle at 40% 70%, rgba(255,255,255,.12), rgba(255,255,255,0) 60%),
        radial-gradient(circle at 82% 66%, rgba(255,255,255,.10), rgba(255,255,255,0) 62%);
      filter: blur(26px);
      transform: translate3d(0,0,0) scale(1.05);
      animation: smokeDrift 1.25s var(--easeApple) forwards;
      mix-blend-mode: screen;
    }
    html.lab .smoke .puff{
      background:
        radial-gradient(circle at 20% 35%, rgba(255,255,255,.18), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 62% 42%, rgba(255,255,255,.12), rgba(255,255,255,0) 58%),
        radial-gradient(circle at 40% 70%, rgba(255,255,255,.10), rgba(255,255,255,0) 60%),
        radial-gradient(circle at 82% 66%, rgba(255,255,255,.08), rgba(255,255,255,0) 62%);
      mix-blend-mode: screen;
    }
    @keyframes smokeDrift{
      0%   { opacity:0; transform:scale(1.00) translateY(10vh); }
      20%  { opacity:1; }
      70%  { opacity:1; transform:scale(1.15) translateY(-2vh) translateX(2vw); }
      100% { opacity:0; transform:scale(1.20) translateY(-8vh) translateX(4vw); }
    }

    /* ==============================
       MODALS (Treasure + Founders Note)
       ============================== */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.38);
      backdrop-filter: blur(12px);
      display:grid;
      place-items:center;
      opacity:0;
      pointer-events:none;
      transition: opacity .22s var(--easeOut);
      z-index:9995;
    }
    .modal.isOn{ opacity:1; pointer-events:auto; }

    .card{
      width:min(720px, calc(100% - 28px));
      background:rgba(255,255,255,.92);
      border:1px solid rgba(17,17,17,.10);
      border-radius:22px;
      box-shadow:0 24px 90px rgba(0,0,0,.22);
      padding:16px;
    }
    html.lab .card{
      background:rgba(18,18,18,.88);
      border-color: rgba(255,255,255,.12);
      box-shadow:0 28px 110px rgba(0,0,0,.60);
      color:#f4f4f4;
    }

    .cardTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px 6px 12px;
    }
    .cardTop strong{ font-size:18px; letter-spacing:-.02em; }

    .xBtn{
      width:36px;height:36px;
      border-radius:999px;
      border:0;
      background:rgba(17,17,17,.06);
      cursor:pointer;
      display:grid;place-items:center;
      transition: transform .18s var(--easeOut), background .18s var(--easeOut);
    }
    html.lab .xBtn{ background:rgba(255,255,255,.10); }
    .xBtn:hover{ background:rgba(17,17,17,.10); }
    html.lab .xBtn:hover{ background:rgba(255,255,255,.14); }
    .xBtn:active{ transform:scale(.98); }
    .xBtn svg{
      width:16px;height:16px;
      stroke:currentColor;stroke-width:2.8;
      fill:none;stroke-linecap:round;stroke-linejoin:round;
      opacity:.85;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
      padding:6px;
    }
    @media (max-width: 700px){
      .grid{ grid-template-columns:1fr; }
    }

    .panel{
      border:1px solid rgba(17,17,17,.10);
      border-radius:18px;
      padding:14px;
      background:rgba(255,255,255,.70);
    }
    html.lab .panel{
      background:rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
    }

    .kicker{ font-size:12.5px; opacity:.72; margin:0 0 8px; }
    .lead{ margin:0; font-size:15px; line-height:1.35; letter-spacing:-.01em; }
    .progress{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(17,17,17,.10);
    }
    html.lab .progress{ border-top-color: rgba(255,255,255,.12); }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(17,17,17,.12);
      background:rgba(255,255,255,.85);
      font-weight:700;
      font-size:13px;
    }
    html.lab .pill{
      border-color: rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
    }
    .ctaRow{ display:flex; gap:10px; justify-content:flex-end; }
    .btn2{
      height:36px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid rgba(17,17,17,.12);
      background:rgba(255,255,255,.90);
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition: transform .18s var(--easeOut), background .18s var(--easeOut);
    }
    html.lab .btn2{
      border-color: rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:#f4f4f4;
    }
    .btn2:hover{ background:#fff; }
    html.lab .btn2:hover{ background:rgba(255,255,255,.12); }
    .btn2:active{ transform:scale(.98); }

    /* ==========================================================
       ✅ HERO BANNER FIX (UPDATED)
       - removes the huge black “section”
       - makes the hero a clean banner
       - uses a FREE coffee image (Unsplash Source)
       ========================================================== */
    .heroWrap{
      /* was: min-height:110vh; background:#000; */
      position:relative;
      height: clamp(420px, 58vh, 640px); /* banner height */
      overflow:hidden;
      background:#000; /* fallback while image loads */
      color:#fff;
    }
    .heroBg{
      /* was: sticky + 88vh */
      position:absolute;
      inset:0;
      overflow:hidden;
    }
    .heroBg img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      transform:scale(1.03);
      display:block;
    }
    .heroShade{
      position:absolute;
      inset:0;
      /* softer, more “banner” feel */
      background:
        radial-gradient(circle at 30% 25%, rgba(0,0,0,.15), rgba(0,0,0,.62));
    }
    .heroContent{
      position:relative;
      height:100%;
      display:grid;
      place-items:center;
      padding:clamp(18px,4vw,56px);
    }
    .glass{
      max-width:820px;
      padding:clamp(22px,3.6vw,40px);
      border-radius:var(--radius);
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter:blur(14px);
      box-shadow:0 18px 60px rgba(0,0,0,.35);
    }

    h1{
      margin:0;
      font-size:clamp(40px,7vw,74px);
      letter-spacing:-0.03em;
    }
    .sub{
      margin-top:12px;
      font-size:clamp(16px,2vw,24px);
      opacity:.9;
    }
    .btn{
      margin-top:24px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:46px;
      padding:0 22px;
      border-radius:999px;
      background:#fff;
      color:#111;
      font-weight:600;
    }

    /* ==============================
       SECTION
       ============================== */
    .section{ padding:72px clamp(18px,4vw,56px); }
    .sectionInner{ max-width:var(--contentMax); margin:0 auto; }

    .sectionTitle{
      font-size:clamp(34px,4.4vw,56px);
      margin:0 0 22px;
      letter-spacing:-0.02em;
      display:flex;
      align-items:center;
      gap:12px;
    }

    /* Coffee highlight */
    #coffee .sectionTitle{
      font-size:clamp(40px,5.2vw,66px);
      letter-spacing:-0.03em;
      margin-bottom:18px;
    }

    /* ==============================
       Tiny Lab Toggle
       ============================== */
    .labToggle{
      margin-left:auto;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .labLabel{
      font-size:12px;
      letter-spacing:.06em;
      text-transform:uppercase;
      opacity:.58;
      white-space:nowrap;
    }
    .switch{
      width:44px;
      height:26px;
      border-radius:999px;
      border:1px solid rgba(17,17,17,.12);
      background:rgba(17,17,17,.06);
      position:relative;
      cursor:pointer;
      transition: background .2s var(--easeOut), border-color .2s var(--easeOut);
    }
    html.lab .switch{
      border-color: rgba(255,255,255,.16);
      background:rgba(255,255,255,.10);
    }
    .knob{
      position:absolute;
      top:3px; left:3px;
      width:20px; height:20px;
      border-radius:999px;
      background:rgba(17,17,17,.72);
      transition: transform .24s var(--easeApple), background .24s var(--easeApple);
    }
    html.lab .knob{
      transform: translateX(18px);
      background:rgba(255,255,255,.84);
    }

    /* ==============================
       APPLE-STYLE RAIL
       ============================== */
    .railWrap{
      width:100vw;
      margin-left:calc(50% - 50vw);
      padding-bottom:78px;
      position:relative;
    }

    .mediaRail{
      display:flex;
      gap:var(--railGap);
      overflow-x:auto;
      padding-left:var(--containerPad);
      padding-right:var(--containerPad);
      scroll-snap-type:x mandatory;
      scroll-behavior:smooth;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior-x:contain;
    }
    .mediaRail::-webkit-scrollbar{ display:none; }

    /* ✅ Tile widths (Red Bull-ish) */
    .mediaRail .tile{
      flex:0 0 auto;
      width:clamp(320px, 72vw, 440px);
      scroll-snap-align:start;
      position:relative;
    }
    @media (min-width: 900px){
      .mediaRail .tile{ width:clamp(360px, 26vw, 440px); }
    }
    @media (min-width: 1280px){
      .mediaRail .tile{ width:clamp(380px, 22vw, 460px); }
    }

    .tile{
      background:var(--cardBg);
      border:1px solid var(--cardStroke);
      border-radius:var(--tileRadius);
      min-height:var(--railTileMinHeight);
      overflow:hidden;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      transition:transform .3s var(--easeApple), box-shadow .3s var(--easeApple);
      will-change:transform;
    }
    .tile:hover{
      transform:translateY(-6px);
      box-shadow:var(--shadowHover);
    }

    .tileMedia{
      aspect-ratio:var(--railMediaRatio);
      background:#fff;
      padding:clamp(16px, 2.2vw, 28px);
      display:grid;
      place-items:center;
    }
    .tileMedia img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }
    .tileBody{
      padding:clamp(18px, 2.2vw, 22px);
      font-size:clamp(16px, 1.6vw, 18px);
      line-height:1.25;
      border-top:1px solid rgba(17,17,17,.06);
    }

    /* ==============================
       ARROWS
       ============================== */
    .railNav{
      position:absolute;
      right:var(--gutter);
      bottom:14px;
      display:flex;
      gap:12px;
    }
    .railArrow{
      width:44px;
      height:44px;
      border-radius:999px;
      background:rgba(0,0,0,.06);
      border:0;
      cursor:pointer;
      display:grid;
      place-items:center;
      transition:transform .18s var(--easeOut), background .18s var(--easeOut), opacity .18s var(--easeOut);
      user-select:none;
      touch-action:manipulation;
      color: var(--pageText);
    }
    .railArrow:active{ transform:scale(.98); }
    .railArrow:hover{ background:rgba(0,0,0,.09); }
    .railArrow svg{
      width:16px;
      height:16px;
      stroke:currentColor;
      stroke-width:3;
      fill:none;
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    @media (max-width: 520px){
      .railNav{ right:calc(var(--gutter) - 6px); bottom:10px; gap:10px; }
      .railArrow{ width:40px; height:40px; }
    }

    /* ==============================
       MOBILE: overlap stack (UNCHANGED)
       ============================== */
    @media (max-width: 760px){
      .railWrap{
        width:100%;
        margin-left:0;
        padding-bottom:36px;
      }
      .mediaRail{
        display:block;
        overflow:visible;
        padding-left:0;
        padding-right:0;
        scroll-snap-type:none;
      }
      .mediaRail .tile{
        width:calc(100% - (var(--gutter) * 2));
        margin:0 auto;
        min-height:72vh;
        position:sticky;
        top:clamp(74px, 10vh, 110px);
        margin-bottom:-18vh;
        border-radius:24px;
        z-index: calc(100 - var(--i, 0));
      }
      .railNav{ display:none; }
      .tileMedia{ padding:18px; }
    }

    /* ==============================
       Treasure “marks”
       ============================== */
    .mark{
      position:absolute;
      width:18px;
      height:18px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      border:1px solid rgba(255,255,255,.45);
      box-shadow:0 0 0 6px rgba(255,255,255,.04);
      background:radial-gradient(circle at 35% 35%, rgba(255,255,255,.9), rgba(255,255,255,.25));
      cursor:pointer;
    }
    html.lab .mark{
      opacity:.14;
      pointer-events:auto;
    }
    html.lab .mark:hover{ opacity:.26; }
    .mark.found{
      opacity:.55 !important;
      box-shadow:0 0 0 8px rgba(90,210,255,.10);
      border-color: rgba(90,210,255,.65);
    }
    .markHero{ top:14px; right:14px; }
    .markCoffee{ bottom:18px; right:18px; }
    .markEvents{ top:8px; left:8px; }
    .mark::after{ content:""; position:absolute; inset:-14px; }
  </style>
</head>

<body>

<!-- LOADER -->
<div class="loader" id="loader" aria-hidden="true">
  <img src="/media/tbp-logo-2.png" alt="The Better Product loading">
</div>

<!-- SMOKE -->
<div class="smoke" id="smoke" aria-hidden="true">
  <div class="puff"></div>
</div>

<!-- TREASURE HUNT MODAL -->
<div class="modal" id="huntModal" aria-hidden="true">
  <div class="card">
    <div class="cardTop">
      <strong>Treasure Hunt</strong>
      <button class="xBtn" id="huntClose" type="button" aria-label="Close">
        <svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18"/></svg>
      </button>
    </div>

    <div class="grid">
      <div class="panel">
        <p class="kicker">Lab Mode is active.</p>
        <p class="lead">
          Find the <strong>three hidden marks</strong>.
          When you collect all three, you unlock the <strong>Founders Note</strong>.
        </p>
        <div class="progress">
          <div class="pill" id="huntPill">0 / 3 Found</div>
          <div class="ctaRow">
            <button class="btn2" id="huntHint" type="button">Hint</button>
            <button class="btn2" id="huntOk" type="button">Let’s go</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <p class="kicker">Hint locations</p>
        <p class="lead" id="hintText">
          One lives near the <strong>top of the page</strong>.<br>
          One hides inside <strong>Coffee</strong>.<br>
          One waits in <strong>Events</strong>.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- FOUNDERS NOTE MODAL -->
<div class="modal" id="foundersModal" aria-hidden="true">
  <div class="card">
    <div class="cardTop">
      <strong>Founders Note</strong>
      <button class="xBtn" id="foundersClose" type="button" aria-label="Close">
        <svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18"/></svg>
      </button>
    </div>

    <div class="panel" style="margin:6px;">
      <p class="kicker">For the ones who look closer.</p>
      <p class="lead" style="font-size:16px; line-height:1.45;">
        The Better Product is built like a quiet obsession:
        fewer things, done better.
        <br><br>
        If you found this, you’re the type of person we build for.
        Coffee is first. Everything else follows the same rule:
        <strong>design-forward, intentional, no compromise.</strong>
        <br><br>
        — The Founders
      </p>
    </div>
  </div>
</div>

<!-- HERO (now a banner, not a huge black section) -->
<section class="heroWrap">
  <div class="heroBg">
    <!-- ✅ Free coffee image (Unsplash Source: no account needed)
         If you want, you can swap this URL later with your own /media/hero-coffee.jpg -->
    <img
      src="https://source.unsplash.com/2400x1400/?coffee,espresso"
      alt="Coffee"
      loading="eager"
      fetchpriority="high"
    >
    <div class="heroShade"></div>
  </div>

  <div class="heroContent">
    <div class="glass" style="position:relative;">
      <!-- Treasure mark #1 (Hero) -->
      <button class="mark markHero" id="markHero" type="button" aria-label="Hidden mark (hero)"></button>

      <h1>The Better Product</h1>
      <p class="sub">Designed simply. Built intentionally.</p>
      <a class="btn" href="#coffee">Coffee</a>
    </div>
  </div>
</section>

<!-- COFFEE -->
<section id="coffee" class="section">
  <div class="sectionInner">
    <h2 class="sectionTitle">
      Coffee.

      <!-- Tiny Lab Mode toggle -->
      <span class="labToggle" title="Lab Mode">
        <span class="labLabel">Lab</span>
        <button class="switch" id="labSwitch" type="button" aria-label="Toggle Lab Mode">
          <span class="knob"></span>
        </button>
      </span>
    </h2>
  </div>

  <div class="railWrap">
    <div class="mediaRail" data-rail>
      <article class="tile">
        <div class="tileMedia"><img src="media/coffee-bag.jpg" alt="Signature Roast"></div>
        <div class="tileBody">
          <strong>Signature Roast</strong> — balanced and smooth.
        </div>
      </article>

      <article class="tile">
        <div class="tileMedia"><img src="media/coffee-can.jpg" alt="Cold Brew"></div>

        <!-- Treasure mark #2 (Coffee) -->
        <button class="mark markCoffee" id="markCoffee" type="button" aria-label="Hidden mark (coffee)"></button>

        <div class="tileBody"><strong>Cold Brew</strong> — clean energy, no compromise.</div>
      </article>

      <article class="tile">
        <div class="tileMedia"><img src="media/coffee-cup.jpg" alt="Everyday Cup"></div>
        <div class="tileBody"><strong>Everyday Cup</strong> — refined and familiar.</div>
      </article>
    </div>

    <div class="railNav">
      <button class="railArrow" type="button" aria-label="Scroll left" data-rail-prev="#coffee">
        <svg viewBox="0 0 24 24"><path d="M14.5 6.5L9 12l5.5 5.5"/></svg>
      </button>
      <button class="railArrow" type="button" aria-label="Scroll right" data-rail-next="#coffee">
        <svg viewBox="0 0 24 24"><path d="M9.5 6.5L15 12l-5.5 5.5"/></svg>
      </button>
    </div>
  </div>
</section>

<!-- EVENTS -->
<section id="events" class="section">
  <div class="sectionInner" style="position:relative;">
    <!-- Treasure mark #3 (Events) -->
    <button class="mark markEvents" id="markEvents" type="button" aria-label="Hidden mark (events)"></button>

    <h2 class="sectionTitle">Events.</h2>
  </div>

  <div class="railWrap">
    <div class="mediaRail" data-rail>
      <article class="tile">
        <div class="tileMedia"><img src="media/event-pop-up.jpg" alt="Pop-Ups"></div>
        <div class="tileBody"><strong>Pop-Ups</strong> — physical presence, real moments.</div>
      </article>
      <article class="tile">
        <div class="tileMedia"><img src="media/event-tasting.jpg" alt="Tastings"></div>
        <div class="tileBody"><strong>Tastings</strong> — experience before purchase.</div>
      </article>
      <article class="tile">
        <div class="tileMedia"><img src="media/event-launch.jpg" alt="Launch Events"></div>
        <div class="tileBody"><strong>Launch Events</strong> — built for attention.</div>
      </article>
    </div>

    <div class="railNav">
      <button class="railArrow" type="button" aria-label="Scroll left" data-rail-prev="#events">
        <svg viewBox="0 0 24 24"><path d="M14.5 6.5L9 12l5.5 5.5"/></svg>
      </button>
      <button class="railArrow" type="button" aria-label="Scroll right" data-rail-next="#events">
        <svg viewBox="0 0 24 24"><path d="M9.5 6.5L15 12l-5.5 5.5"/></svg>
      </button>
    </div>
  </div>
</section>

<script>
  // =========================
  // Helpers
  // =========================
  const $ = (s, r=document) => r.querySelector(s);

  const themeMeta = document.getElementById('themeColorMeta');
  function setThemeColor(hex){
    if(themeMeta) themeMeta.setAttribute('content', hex);
  }

  // =========================
  // Loader (logo flash)
  // =========================
  const loader = document.getElementById('loader');
  let loaderTimer = null;
  let lastShow = 0;

  function showLoader(ms = 700){
    const now = Date.now();
    if (now - lastShow < 350) return;
    lastShow = now;

    loader.classList.add('isOn');
    clearTimeout(loaderTimer);
    loaderTimer = setTimeout(() => loader.classList.remove('isOn'), ms);
  }

  window.addEventListener('pageshow', () => showLoader(700));

  // =========================
  // Rail arrows scroll by 1 tile
  // =========================
  function scrollRail(sectionSelector, dir){
    const section = document.querySelector(sectionSelector);
    if(!section) return;
    const rail = section.querySelector('.mediaRail');
    const tile = rail?.querySelector('.tile');
    if(!rail || !tile) return;

    const railStyle = getComputedStyle(rail);
    const gap = parseFloat(railStyle.columnGap || railStyle.gap || 0) || 0;
    const amount = tile.getBoundingClientRect().width + gap;

    rail.scrollBy({ left: dir * amount, behavior: 'smooth' });
  }

  document.addEventListener('click', (e) => {
    const prevBtn = e.target.closest('[data-rail-prev]');
    const nextBtn = e.target.closest('[data-rail-next]');
    if(prevBtn){
      scrollRail(prevBtn.getAttribute('data-rail-prev'), -1);
    }
    if(nextBtn){
      scrollRail(nextBtn.getAttribute('data-rail-next'), 1);
    }
  }, { passive: true });

  // Mobile overlap stacking index
  document.querySelectorAll('.mediaRail').forEach(rail=>{
    rail.querySelectorAll('.tile').forEach((tile, i)=>{
      tile.style.setProperty('--i', i);
    });
  });

  // =========================
  // Lab Mode + Treasure Hunt
  // =========================
  const labSwitch = document.getElementById('labSwitch');
  const smoke = document.getElementById('smoke');

  const huntModal = document.getElementById('huntModal');
  const huntClose = document.getElementById('huntClose');
  const huntOk = document.getElementById('huntOk');
  const huntHint = document.getElementById('huntHint');
  const huntPill = document.getElementById('huntPill');
  const hintText = document.getElementById('hintText');

  const foundersModal = document.getElementById('foundersModal');
  const foundersClose = document.getElementById('foundersClose');

  const marks = {
    hero: document.getElementById('markHero'),
    coffee: document.getElementById('markCoffee'),
    events: document.getElementById('markEvents')
  };

  const LS_LAB = 'tbp_lab';
  const LS_FOUND = 'tbp_found'; // JSON array

  function getFound(){
    try{
      return JSON.parse(localStorage.getItem(LS_FOUND) || '[]');
    }catch{ return []; }
  }
  function setFound(arr){
    localStorage.setItem(LS_FOUND, JSON.stringify(arr));
  }

  function updateProgress(){
    const found = getFound();
    const count = found.length;
    huntPill.textContent = `${count} / 3 Found`;

    // mark UI state
    Object.entries(marks).forEach(([k, el])=>{
      if(!el) return;
      el.classList.toggle('found', found.includes(k));
    });

    if(count >= 3){
      // unlock Founders Note
      closeHunt();
      openFounders();
    }
  }

  function openHunt(){
    huntModal.classList.add('isOn');
    huntModal.setAttribute('aria-hidden','false');
    updateProgress();
  }
  function closeHunt(){
    huntModal.classList.remove('isOn');
    huntModal.setAttribute('aria-hidden','true');
  }

  function openFounders(){
    foundersModal.classList.add('isOn');
    foundersModal.setAttribute('aria-hidden','false');
  }
  function closeFounders(){
    foundersModal.classList.remove('isOn');
    foundersModal.setAttribute('aria-hidden','true');
  }

  function smokeTransition(){
    smoke.classList.add('isOn');
    // restart animation (reflow)
    const puff = smoke.querySelector('.puff');
    if(puff){
      puff.style.animation = 'none';
      puff.offsetHeight;
      puff.style.animation = '';
    }
    setTimeout(()=> smoke.classList.remove('isOn'), 1250);
  }

  function setLabMode(on){
    document.documentElement.classList.toggle('lab', on);
    localStorage.setItem(LS_LAB, on ? '1' : '0');

    // update browser UI tint
    setThemeColor(
      on
        ? getComputedStyle(document.documentElement).getPropertyValue('--uiTintLab').trim()
        : getComputedStyle(document.documentElement).getPropertyValue('--uiTint').trim()
    );

    smokeTransition();

    // show hunt on enable
    if(on){
      setTimeout(openHunt, 520);
    }else{
      closeHunt();
      closeFounders();
    }
  }

  // init from storage
  const savedLab = localStorage.getItem(LS_LAB) === '1';
  setLabMode(savedLab);

  labSwitch.addEventListener('click', () => {
    const isOn = document.documentElement.classList.contains('lab');
    setLabMode(!isOn);
  });

  huntClose.addEventListener('click', closeHunt);
  huntOk.addEventListener('click', closeHunt);
  huntModal.addEventListener('click', (e) => { if(e.target === huntModal) closeHunt(); });

  foundersClose.addEventListener('click', closeFounders);
  foundersModal.addEventListener('click', (e) => { if(e.target === foundersModal) closeFounders(); });

  huntHint.addEventListener('click', () => {
    const found = getFound();
    const hints = [
      'Try the page top — a corner that feels “too clean.”',
      'In Coffee, the cleanest tile hides the loudest secret.',
      'In Events, it’s near the beginning — not the center.'
    ];
    // rotate hint based on progress
    hintText.innerHTML = hints[Math.min(found.length, hints.length-1)].replaceAll('\n','<br>');
  });

  // only allow mark clicks in Lab mode
  function collect(key){
    if(!document.documentElement.classList.contains('lab')) return;
    const found = getFound();
    if(found.includes(key)) return;
    found.push(key);
    setFound(found);
    updateProgress();
  }

  marks.hero?.addEventListener('click', ()=>collect('hero'));
  marks.coffee?.addEventListener('click', ()=>collect('coffee'));
  marks.events?.addEventListener('click', ()=>collect('events'));

  // If already completed, show Founders Note when enabling Lab Mode
  updateProgress();
</script>

</body>
</html>
